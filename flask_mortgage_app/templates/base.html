<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>Mortgage Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- HTMX -->
  <script src="https://unpkg.com/htmx.org@1.9.6"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* THEME TOKENS */
    :root {
      --bg: #ffffff;
      --surface: #f8fafc;
      --text: #0f172a;
      --muted: #475569;
      --primary: #2563eb;
      --ring: rgba(37,99,235,.35);
      --card: #ffffff;
      --border: #e2e8f0;
      --input: #ffffff;
    }
    [data-theme="medium"] {
      --bg: #0b1220;
      --surface: #121a2a;
      --text: #e5e7eb;
      --muted: #9aa6b2;
      --primary: #60a5fa;
      --ring: rgba(96,165,250,.45);
      --card: #0e1626;
      --border: #1f2937;
      --input: #1a2436;
    }
    [data-theme="dark"] {
      --bg: #0a0a0a;
      --surface: #111111;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --primary: #38bdf8;
      --ring: rgba(56,189,248,.45);
      --card: #0f0f0f;
      --border: #1f2937;
      --input: #1e1e1e;
    }

    /* Tabs as pills */
    .tab-btn {
      background: var(--surface);
      color: var(--muted);
      border: 1px solid var(--border);
      transition: background 0.2s, color 0.2s, border-color 0.2s;
    }
    .tab-btn:hover { background: var(--card); color: var(--text); }
    .tab-btn[aria-selected="true"] {
      color: var(--primary);
      border-color: var(--primary);
      background: var(--card);
    }

    /* Form controls (theme-aware) */
    input, select, textarea {
      background: var(--input);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      padding: 0.5rem;
      display: block;
      width: 100%;
      box-sizing: border-box;
      min-height: 2.5rem;
      line-height: 1.25rem;
      min-width: 0;
    }
    input:focus, select:focus, textarea:focus {
      outline: 2px solid var(--ring);
      outline-offset: 2px;
    }
    input[type="range"] { padding: 0; min-height: auto; background: transparent; }
    input[type="checkbox"], input[type="radio"] { width: auto; min-height: auto; padding: 0; }

    /* Base tokens -> utilities */
    body { background: var(--bg); color: var(--text); }
    .surface { background: var(--surface); }
    .card { background: var(--card); border: 1px solid var(--border); }
    .muted { color: var(--muted); }
    .btn {
      @apply inline-flex items-center gap-2 rounded-xl px-3 py-2 text-sm font-medium transition;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
    }
    .btn:hover { filter: brightness(1.05); }
    .btn-primary { background: var(--primary); color: #0b1220; border-color: transparent; }
    .focus-ring:focus { outline: 3px solid var(--ring); outline-offset: 2px; }
    .tab-active { border-color: var(--primary) !important; color: var(--primary) !important; }
    .banner-hidden { display: none; }

    /* Label structure (prevents overlap) */
    label {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      font-size: 0.875rem;
      color: var(--muted);
    }
  </style>
</head>
<body class="min-h-screen">

  <!-- HEADER -->
  <header class="surface border-b" style="border-color: var(--border);">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-8 w-8 rounded-lg" style="background: var(--primary)"></div>
        <h1 class="text-lg font-semibold">Mortgage Dashboard</h1>
      </div>
      <div class="flex items-center gap-2">
        <label for="theme-select" class="muted text-sm">Theme</label>
        <select id="theme-select" class="btn focus-ring" aria-label="Select theme">
          <option value="light">Light</option>
          <option value="medium">Medium</option>
          <option value="dark">Dark</option>
        </select>
        <!-- NEW: Show Help button (appears when banner is hidden) -->
        <button id="show-banner" class="btn focus-ring text-sm hidden" aria-label="Show help banner">
          Show Help
        </button>
      </div>
    </div>
  </header>

  <!-- HOW-TO BANNER -->
  <section id="howto-banner" class="surface border-b" style="border-color: var(--border);">
    <div class="max-w-7xl mx-auto px-4 py-3">
      <div class="flex items-start justify-between gap-4">
        <nav class="flex flex-wrap gap-2" role="tablist" aria-label="How to">
          <button class="tab-btn px-3 py-1 rounded-lg text-sm font-medium border" role="tab" aria-selected="true" aria-controls="tab-overview" id="tabbtn-overview">Overview</button>
          <button class="tab-btn px-3 py-1 rounded-lg text-sm font-medium border" role="tab" aria-selected="false" aria-controls="tab-howto" id="tabbtn-howto">How to use</button>
          <button class="tab-btn px-3 py-1 rounded-lg text-sm font-medium border" role="tab" aria-selected="false" aria-controls="tab-assumptions" id="tabbtn-assumptions">Assumptions</button>
          <button class="tab-btn px-3 py-1 rounded-lg text-sm font-medium border" role="tab" aria-selected="false" aria-controls="tab-faq" id="tabbtn-faq">FAQ</button>
          <button class="tab-btn px-3 py-1 rounded-lg text-sm font-medium border" role="tab" aria-selected="false" aria-controls="tab-tips" id="tabbtn-tips">Tips</button>
        </nav>
        <div class="flex items-center gap-2">
          <button id="dismiss-banner" class="btn focus-ring text-sm" aria-label="Hide help banner">Hide</button>
        </div>
      </div>

      <div class="mt-3 grid">
        <div id="tab-overview" role="tabpanel" aria-labelledby="tabbtn-overview">
          <div class="card rounded-xl p-4 text-sm muted">
            This dashboard estimates monthly payments, total interest, and amortization based on loan inputs.
          </div>
        </div>
        <div id="tab-howto" role="tabpanel" class="hidden" aria-labelledby="tabbtn-howto">
          <div class="card rounded-xl p-4 text-sm muted">
            <ol class="list-decimal pl-4 space-y-1">
              <li>Enter home price, down payment %, interest rate, and term.</li>
              <li>Toggle PMI on/off or enter PMI rate.</li>
              <li>Add taxes, insurance, HOA if needed.</li>
              <li>Check charts/tables for breakdowns and sensitivity.</li>
            </ol>
          </div>
        </div>
        <div id="tab-assumptions" role="tabpanel" class="hidden" aria-labelledby="tabbtn-assumptions">
          <div class="card rounded-xl p-4 text-sm muted">
            <ul class="list-disc pl-4 space-y-1">
              <li>Fixed-rate, fully amortizing loan.</li>
              <li>PMI drops at 80% LTV unless overridden.</li>
              <li>Taxes/insurance treated as monthly escrows.</li>
            </ul>
          </div>
        </div>
        <div id="tab-faq" role="tabpanel" class="hidden" aria-labelledby="tabbtn-faq">
          <div class="card rounded-xl p-4 text-sm muted">
            <p><strong>Why did my payment change?</strong> Taxes/insurance and PMI can cause bigger swings than principal/interest.</p>
          </div>
        </div>
        <div id="tab-tips" role="tabpanel" class="hidden" aria-labelledby="tabbtn-tips">
          <div class="card rounded-xl p-4 text-sm muted">
            <ul class="list-disc pl-4 space-y-1">
              <li>Try bi-weekly payments to cut interest.</li>
              <li>Compare 15 vs 30 years for total savings.</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- PAGE CONTENT -->
  <main class="max-w-7xl mx-auto p-6">
    {% block content %}{% endblock %}
  </main>

  <!-- Site scripts -->
  <script src="{{ url_for('static', filename='charts.js') }}"></script>
  <script>
    // THEME SWITCHER
    const root = document.documentElement;
    const select = document.getElementById('theme-select');
    const saved = localStorage.getItem('theme') || 'light';
    root.setAttribute('data-theme', saved);
    select.value = saved;
    select.addEventListener('change', () => {
      root.setAttribute('data-theme', select.value);
      localStorage.setItem('theme', select.value);
      // Ask charts (if loaded) to re-theme
      if (window.__lastChartsPayload && window.initCharts) {
        window.initCharts(window.__lastChartsPayload);
      }
    });

    // TABS (banner)
    const tabButtons = ['overview','howto','assumptions','faq','tips'].map(k => document.getElementById(`tabbtn-${k}`));
    const panels = ['tab-overview','tab-howto','tab-assumptions','tab-faq','tab-tips'].map(id => document.getElementById(id));
    function activate(idx){
      tabButtons.forEach((btn,i)=>{
        const active = i===idx;
        btn.classList.toggle('tab-active', active);
        btn.setAttribute('aria-selected', active ? 'true' : 'false');
        panels[i].classList.toggle('hidden', !active);
      });
    }
    tabButtons.forEach((btn,idx)=> btn.addEventListener('click', ()=> activate(idx)));
    activate(0);

    // ----- BANNER HIDE/SHOW + CHROME OFFSET -----
    const banner = document.getElementById('howto-banner');
    const dismissBtn = document.getElementById('dismiss-banner');
    const showBtn = document.getElementById('show-banner');

    function setChromeOffset(){
      const header = document.querySelector('header');
      const h = (header?.offsetHeight || 0) + (banner && !banner.classList.contains('banner-hidden') ? banner.offsetHeight : 0);
      document.documentElement.style.setProperty('--chrome', h + 'px');
    }

    function hideBanner(){
      banner.classList.add('banner-hidden');
      localStorage.setItem('hideHowto','1');
      showBtn.classList.remove('hidden');
      setChromeOffset();
    }
    function showBanner(){
      banner.classList.remove('banner-hidden');
      localStorage.setItem('hideHowto','0');
      showBtn.classList.add('hidden');
      setChromeOffset();
    }

    // Initial state
    if (localStorage.getItem('hideHowto') === '1') {
      hideBanner();
    } else {
      showBanner();
    }

    // Events
    dismissBtn.addEventListener('click', hideBanner);
    showBtn.addEventListener('click', showBanner);
    window.addEventListener('load', setChromeOffset);
    window.addEventListener('resize', setChromeOffset);
    document.body.addEventListener('htmx:afterSwap', setChromeOffset);

    // HTMX + charts payload
    htmx.config.allowScriptTags = true;
    document.body.addEventListener('htmx:afterSwap', (e) => {
      if (e.detail?.target?.id === 'results') {
        const payloadEl = document.getElementById('charts-payload');
        if (payloadEl) {
          try {
            const data = JSON.parse(payloadEl.textContent);
            window.__lastChartsPayload = data;     // keep for theme changes
            if (window.initCharts) window.initCharts(data);
          } catch (err) {
            console.error('Charts payload parse error:', err);
          }
        }
      }
    });
    window.addEventListener('DOMContentLoaded', () => {
      const results = document.getElementById('results');
      if (results) htmx.trigger(results, 'load');
      setChromeOffset();
    });
  </script>
</body>
</html>
