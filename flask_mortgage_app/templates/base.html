<!DOCTYPE html>
<html lang="en" data-theme="light" class="text-[16px] sm:text-[16px] md:text-[17px] lg:text-[18px]">
<head>
  <meta charset="UTF-8" />
  <title>Mortgage Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="format-detection" content="telephone=no">

  <!-- Tailwind CDN (non-deferred so classes compile immediately) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- HTMX + Chart.js (defer -> faster paint) -->
  <script defer src="https://unpkg.com/htmx.org@1.9.6"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root { --bg:#fff; --surface:#f8fafc; --text:#0f172a; --muted:#475569; --primary:#2563eb; --ring:rgba(37,99,235,.35); --card:#fff; --border:#e2e8f0; --input:#fff; }
    [data-theme="medium"] { --bg:#0b1220; --surface:#121a2a; --text:#e5e7eb; --muted:#9aa6b2; --primary:#60a5fa; --ring:rgba(96,165,250,.45); --card:#0e1626; --border:#1f2937; --input:#1a2436; }
    [data-theme="dark"] { --bg:#0a0a0a; --surface:#111; --text:#e5e7eb; --muted:#9ca3af; --primary:#38bdf8; --ring:rgba(56,189,248,.45); --card:#0f0f0f; --border:#1f2937; --input:#1e1e1e; }

    html,body{overflow-x:hidden;background:var(--bg);color:var(--text)}
    .surface{background:var(--surface)} .card{background:var(--card);border:1px solid var(--border)} .muted{color:var(--muted)}
    .btn{display:inline-flex;align-items:center;gap:.5rem;border-radius:.75rem;padding:.5rem .75rem;font-size:.875rem;font-weight:500;transition:filter .15s;background:var(--surface);border:1px solid var(--border);color:var(--text)}
    .btn:hover{filter:brightness(1.05)} .btn-primary{background:var(--primary);color:#0b1220;border-color:transparent}
    .focus-ring:focus{outline:3px solid var(--ring);outline-offset:2px}
    .tab-btn{background:var(--surface);color:var(--muted);border:1px solid var(--border);transition:.2s;border-radius:.5rem;padding:.25rem .75rem;font-size:.875rem;font-weight:600}
    .tab-btn:hover{background:var(--card);color:var(--text)}
    .tab-btn[aria-selected="true"]{color:var(--primary);border-color:var(--primary);background:var(--card)}
    .banner-hidden{display:none}
    .chart-box{position:relative;height:16rem}@media(min-width:640px){.chart-box{height:20rem}}@media(min-width:768px){.chart-box{height:24rem}}
    .glass{backdrop-filter:saturate(120%) blur(10px);-webkit-backdrop-filter:saturate(120%) blur(10px);background:color-mix(in oklab,var(--bg) 85%,transparent)}
  </style>
</head>
<body class="min-h-screen">

  <!-- Sticky header -->
  <header class="surface border-b sticky top-0 z-50 glass" style="border-color: var(--border);">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-8 w-8 rounded-lg" style="background: var(--primary)"></div>
        <h1 class="text-lg font-semibold">Mortgage Dashboard</h1>
      </div>
      <div class="flex items-center gap-2">
        <label for="theme-select" class="muted text-sm">Theme</label>
        <select id="theme-select" class="btn focus-ring" aria-label="Select theme">
          <option value="light">Light</option>
          <option value="medium">Medium</option>
          <option value="dark">Dark</option>
        </select>
        <button id="show-banner" class="btn focus-ring text-sm hidden" aria-label="Show help banner">Show Help</button>
      </div>
    </div>
  </header>

  <!-- How-to banner -->
  <section id="howto-banner" class="surface border-b" style="border-color: var(--border);">
    <div class="max-w-7xl mx-auto px-4 py-3">
      <div class="flex items-start justify-between gap-4">
        <nav class="flex flex-wrap gap-2" role="tablist" aria-label="How to">
          <button class="tab-btn" role="tab" aria-selected="true" aria-controls="tab-overview" id="tabbtn-overview">Overview</button>
          <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-howto" id="tabbtn-howto">How to use</button>
          <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-assumptions" id="tabbtn-assumptions">Assumptions</button>
          <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-faq" id="tabbtn-faq">FAQ</button>
          <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-tips" id="tabbtn-tips">Tips</button>
        </nav>
        <button id="dismiss-banner" class="btn focus-ring text-sm" aria-label="Hide help banner">Hide</button>
      </div>

      <div class="mt-3 grid">
        <div id="tab-overview" role="tabpanel" aria-labelledby="tabbtn-overview">
          <div class="card rounded-xl p-4 text-sm muted">
            This dashboard estimates monthly payments, total interest, and amortization based on loan inputs.
          </div>
        </div>
        <div id="tab-howto" role="tabpanel" class="hidden" aria-labelledby="tabbtn-howto">
          <div class="card rounded-xl p-4 text-sm muted">
            <ol class="list-decimal pl-4 space-y-1">
              <li>Enter home price, down payment %, interest rate, and term.</li>
              <li>Toggle or enter PMI.</li>
              <li>Add taxes, insurance, HOA if needed.</li>
              <li>See breakdowns and amortization on the right.</li>
            </ol>
          </div>
        </div>
        <div id="tab-assumptions" role="tabpanel" class="hidden" aria-labelledby="tabbtn-assumptions">
          <div class="card rounded-xl p-4 text-sm muted">
            <ul class="list-disc pl-4 space-y-1">
              <li>Fixed-rate, fully amortizing loan.</li>
              <li>PMI drops at 80% LTV unless overridden.</li>
              <li>Taxes/insurance treated as monthly escrows.</li>
            </ul>
          </div>
        </div>
        <div id="tab-faq" role="tabpanel" class="hidden" aria-labelledby="tabbtn-faq">
          <div class="card rounded-xl p-4 text-sm muted">
            <p><strong>Why did my payment change?</strong> Taxes/insurance and PMI can swing totals more than P&I.</p>
          </div>
        </div>
        <div id="tab-tips" role="tabpanel" class="hidden" aria-labelledby="tabbtn-tips">
          <div class="card rounded-xl p-4 text-sm muted">
            <ul class="list-disc pl-4 space-y-1">
              <li>Try bi-weekly payments to cut interest.</li>
              <li>Compare 15y vs 30y for savings.</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Page body -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 py-4 sm:py-6" style="padding-top: var(--chrome, 0px);">
    {% block content %}{% endblock %}
  </main>

  <!-- Scripts -->
  <script defer src="{{ url_for('static', filename='charts.js') }}"></script>
  <script>
    // Theme select (persists + re-init charts if your charts.js exposes initCharts)
    const root=document.documentElement, select=document.getElementById('theme-select');
    const saved=localStorage.getItem('theme')||'light'; root.setAttribute('data-theme',saved); select.value=saved;
    select.addEventListener('change',()=>{ root.setAttribute('data-theme',select.value); localStorage.setItem('theme',select.value);
      if(window.__lastChartsPayload && window.initCharts){ window.initCharts(window.__lastChartsPayload); }
    });

    // Banner tabs
    const tabButtons=['overview','howto','assumptions','faq','tips'].map(k=>document.getElementById(`tabbtn-${k}`));
    const panels=['tab-overview','tab-howto','tab-assumptions','tab-faq','tab-tips'].map(id=>document.getElementById(id));
    function activate(i){ tabButtons.forEach((b,idx)=>{ const on=idx===i; b.setAttribute('aria-selected',on?'true':'false'); panels[idx].classList.toggle('hidden',!on); }); }
    tabButtons.forEach((b,i)=>b.addEventListener('click',()=>activate(i))); activate(0);

    // Hide / show banner
    const banner=document.getElementById('howto-banner'), dismissBtn=document.getElementById('dismiss-banner'), showBtn=document.getElementById('show-banner');
    function setChromeOffset(){ const h=document.querySelector('header')?.offsetHeight||0; document.documentElement.style.setProperty('--chrome',h+'px'); }
    function hideBanner(){ banner.classList.add('banner-hidden'); localStorage.setItem('hideHowto','1'); showBtn.classList.remove('hidden'); }
    function showBanner(){ banner.classList.remove('banner-hidden'); localStorage.setItem('hideHowto','0'); showBtn.classList.add('hidden'); }
    if(localStorage.getItem('hideHowto')==='1'){ hideBanner(); } else { showBanner(); }
    dismissBtn.addEventListener('click',hideBanner); showBtn.addEventListener('click',showBanner);
    window.addEventListener('load',setChromeOffset); window.addEventListener('resize',setChromeOffset);
    document.body.addEventListener('htmx:afterSwap',setChromeOffset);

    // When results load, hand data to charts.js (if it provides window.initCharts)
    if(window.htmx){
      htmx.config.allowScriptTags=true;
      document.body.addEventListener('htmx:afterSwap',(e)=>{
        if(e.detail?.target?.id==='results'){
          const payloadEl=document.getElementById('charts-payload');
          if(payloadEl){
            try{
              const data=JSON.parse(payloadEl.textContent);
              window.__lastChartsPayload=data;
              if(window.initCharts) window.initCharts(data);
              if(window.Chart && Chart.instances){ Object.values(Chart.instances).forEach(inst=>inst.resize()); }
            }catch(err){ console.error('Charts payload parse error:',err); }
          }
        }
      });
      window.addEventListener('DOMContentLoaded',()=>{ const r=document.getElementById('results'); if(r) htmx.trigger(r,'load'); });
    }
  </script>
</body>
</html>
