{% extends "base.html" %}
{% block content %}

<!-- Two-panel layout: inputs (left, scrollable) + results (right, sticky) -->
<section class="grid grid-cols-1 lg:grid-cols-2 gap-6"
         style="height: calc(100vh - var(--chrome, 0px));">

  <!-- LEFT: INPUTS (scrollable column) -->
  <div class="overflow-y-auto pr-2">
    <form id="mortgage-form"
          class="space-y-6 pb-8"
          hx-post="/results"
          hx-target="#results"
          hx-swap="innerHTML"
          hx-trigger="change, keyup changed delay:500ms">

      <!-- Home & Loan -->
      <div class="card rounded-xl p-4 space-y-4">
        <h2 class="text-lg font-semibold">Home &amp; Loan</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <label>Home Price ($)
            <input type="number" name="price" id="price" value="{{ defaults.price }}" class="w-full">
          </label>

          <label>Start Date
            <input type="date" name="start_date" value="{{ defaults.start_date.strftime('%Y-%m-%d') }}" class="w-full">
          </label>

          <label>Interest Rate (% APR)
            <input type="number" name="rate" step="0.01" value="{{ defaults.rate }}" class="w-full">
          </label>

          <label>Term (years)
            <input type="number" name="years" value="{{ defaults.years }}" class="w-full">
          </label>

          <div class="md:col-span-2">
            <label>Down Payment (%) â€” slider</label>
            <input type="range" min="0" max="50" step="1" name="down_pct" id="down_pct" value="{{ defaults.down_pct }}" class="w-full">
            <div class="text-sm muted mt-1">
              <span id="down_pct_label">{{ defaults.down_pct }}</span>%
            </div>
          </div>

          <label>PMI Annual Rate (%)
            <input type="number" step="0.01" name="pmi_rate" value="{{ defaults.pmi_rate }}" class="w-full">
          </label>

          <label class="inline-flex items-center gap-2">
            <input type="checkbox" name="pmi_exempt" {% if defaults.pmi_exempt %}checked{% endif %}>
            PMI Exemption / Waiver
          </label>

          <label>Down Payment ($)
            <input type="number" id="down_dollars" class="w-full"
                   value="{{ (defaults.price * defaults.down_pct / 100.0) | round(0) }}">
          </label>
        </div>
      </div>

      <!-- Maintenance -->
      <div class="card rounded-xl p-4 space-y-4">
        <h2 class="text-lg font-semibold">Maintenance (Annual $)</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          {% for key, val in defaults.maintenance.items() %}
          <label>{{ key|capitalize }}
            <input type="number" name="maint_{{ key }}" value="{{ val }}" class="w-full">
          </label>
          {% endfor %}
        </div>
      </div>

      <!-- Taxes & Costs -->
      <div class="card rounded-xl p-4 space-y-4">
        <h2 class="text-lg font-semibold">Taxes &amp; Other Costs</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <label>Property Taxes ($/mo)
            <input type="number" name="taxes_monthly" value="{{ defaults.taxes_monthly }}" class="w-full">
          </label>
          <label>Insurance ($/mo)
            <input type="number" name="insurance_monthly" value="{{ defaults.insurance_monthly }}" class="w-full">
          </label>
          <label>HOA ($/mo)
            <input type="number" name="hoa_monthly" value="{{ defaults.hoa_monthly }}" class="w-full">
          </label>
        </div>
      </div>

      <!-- Rent -->
      <div class="card rounded-xl p-4 space-y-4">
        <h2 class="text-lg font-semibold">Rent Assumptions</h2>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
          <label>Starting Rent ($/mo)
            <input type="number" name="rent" value="{{ defaults.rent }}" class="w-full">
          </label>
          <label>Rent Growth (%/yr)
            <input type="number" step="0.1" name="rent_growth" value="{{ defaults.rent_growth }}" class="w-full">
          </label>
        </div>
      </div>

      <!-- Resale enable -->
      <label class="inline-flex items-center gap-2 card rounded-xl p-3">
        <input type="checkbox" name="resale_enable" {% if defaults.resale_enable %}checked{% endif %}>
        Enable Resale Scenario
      </label>

      <!-- Resale -->
      <div class="card rounded-xl p-4 space-y-4">
        <h2 class="text-lg font-semibold">Resale</h2>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
          <label>Resale Value ($)
            <input type="number" name="resale_value" value="{{ defaults.resale_value }}" class="w-full">
          </label>
          <label>Resale Date
            <input type="date" name="resale_date" value="{{ defaults.resale_date.strftime('%Y-%m-%d') }}" class="w-full">
          </label>
          <label>Selling Cost (%)
            <input type="number" step="0.1" name="selling_cost_pct" value="{{ defaults.selling_cost_pct }}" class="w-full">
          </label>
        </div>
      </div>

      <!-- Tax -->
      <div class="card rounded-xl p-4 space-y-4">
        <h2 class="text-lg font-semibold">Tax Deduction (Optional)</h2>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 items-center">
          <label class="inline-flex items-center gap-2">
            <input type="checkbox" name="tax_deduction" {% if defaults.tax_deduction %}checked{% endif %}>
            Apply to interest + property tax
          </label>
          <label>Marginal Tax Rate (%)
            <input type="number" step="0.1" name="tax_rate" value="{{ defaults.tax_rate }}" class="w-full">
          </label>
        </div>
      </div>

      <!-- Refi -->
      <div class="card rounded-xl p-4 space-y-4">
        <h2 class="text-lg font-semibold">Refinance (Optional)</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 items-center">
          <label class="inline-flex items-center gap-2">
            <input type="checkbox" name="refi_enable" {% if defaults.refi_enable %}checked{% endif %}>
            Enable Refi Compare
          </label>
          <label>Refi Rate (%)
            <input type="number" step="0.01" name="refi_rate" value="{{ defaults.refi_rate }}" class="w-full">
          </label>
          <label>Refi Term (years)
            <input type="number" name="refi_years" value="{{ defaults.refi_years }}" class="w-full">
          </label>
          <label>Closing Costs ($)
            <input type="number" name="refi_closing" value="{{ defaults.refi_closing }}" class="w-full">
          </label>
          <label>Refi Start Date
            <input type="date" name="refi_start_date" value="{{ defaults.start_date.strftime('%Y-%m-%d') }}" class="w-full">
          </label>
        </div>
      </div>

      <!-- Controls -->
      <div class="card rounded-xl p-4">
        <div class="flex flex-wrap items-center gap-4">
          <label>Amortization rows:
            <select name="amort_scope" class="w-full md:w-auto">
              <option value="12" {% if defaults.amort_scope==12 %}selected{% endif %}>12</option>
              <option value="60">60</option>
              <option value="360">Full</option>
            </select>
          </label>

          <button class="btn btn-primary"
                  form="mortgage-form" formaction="/pdf" formmethod="post" target="_blank">
            Download Report (PDF)
          </button>
        </div>
      </div>
    </form>

    <!-- inputs helpers -->
    <script>
      // Down payment slider <-> dollars sync
      const priceEl = document.getElementById('price');
      const pctEl = document.getElementById('down_pct');
      const pctLab = document.getElementById('down_pct_label');
      const dollarsEl = document.getElementById('down_dollars');
      function syncFromPct() {
        const price = parseFloat(priceEl.value || 0);
        const pct = parseFloat(pctEl.value || 0);
        const dollars = Math.round(price * pct / 100.0);
        dollarsEl.value = dollars; pctLab.textContent = pct;
      }
      function syncFromDollars() {
        const price = parseFloat(priceEl.value || 0);
        const dollars = parseFloat(dollarsEl.value || 0);
        const pct = price > 0 ? Math.round((dollars / price) * 100.0) : 0;
        pctEl.value = Math.max(0, Math.min(100, pct)); pctLab.textContent = pctEl.value;
      }
      pctEl.addEventListener('input', syncFromPct);
      priceEl.addEventListener('input', syncFromPct);
      dollarsEl.addEventListener('input', syncFromDollars);
      syncFromPct();

      // Reset amortization paging to page 1 on any input change
      document.getElementById('mortgage-form').addEventListener('change', () => {
        const pageEl = document.getElementById('page'); if (pageEl) pageEl.value = 1;
      });
    </script>
  </div>

  <!-- RIGHT: RESULTS (sticky so charts always show) -->
  <div class="relative">
    <div class="sticky top-4">
      <div id="results"
           hx-post="/results"
           hx-target="#results"
           hx-swap="innerHTML"
           hx-include="#mortgage-form"
           hx-trigger="load"></div>
    </div>
  </div>
</section>
{% endblock %}
